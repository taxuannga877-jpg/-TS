# 🔬 过渡态预测模型 - 完整复现指南

## 📋 目录
1. [环境配置](#环境配置)
2. [数据准备](#数据准备)
3. [模型训练](#模型训练)
4. [模型预测](#模型预测)
5. [结果评估](#结果评估)
6. [技术细节](#技术细节)

---

## 🖥️ 环境配置

### 系统要求
- **操作系统**: Linux / Windows / macOS
- **Python**: 3.8+
- **内存**: 8GB+ RAM
- **GPU**: 可选（支持CUDA的GPU可加速训练）
- **CPU**: 多核CPU（本项目已针对CPU优化）

### 步骤1：创建Python环境

```bash
# 使用conda（推荐）
conda create -n ts_pred python=3.10
conda activate ts_pred

# 或使用venv
python -m venv ts_env
source ts_env/bin/activate  # Linux/Mac
# ts_env\Scripts\activate   # Windows
```

### 步骤2：安装依赖

```bash
pip install -r requirements.txt
```

**依赖包说明**:
```
torch>=2.0.0          # PyTorch核心库
numpy>=1.20.0         # 数值计算
scipy>=1.7.0          # 科学计算（RMSD对齐）
ase>=3.22.0           # 原子模拟环境（读写XYZ文件）
tensorboard>=2.10.0   # 训练可视化
tqdm>=4.60.0          # 进度条显示
h5py>=3.0.0          # HDF5数据格式支持（可选）
```

### 步骤3：验证安装

```bash
python -c "import torch; print(f'PyTorch: {torch.__version__}')"
python -c "import ase; print('ASE安装成功')"
```

---

## 📂 数据准备

### 数据格式要求

训练/测试数据必须遵循以下目录结构：

```
train_data/              # 训练数据根目录
├── rxn1/
│   ├── RS.xyz          # 反应物坐标（Reactant Structure）
│   ├── PS.xyz          # 产物坐标（Product Structure）
│   └── TS.xyz          # 过渡态坐标（Transition State，仅训练时需要）
├── rxn2/
│   ├── RS.xyz
│   ├── PS.xyz
│   └── TS.xyz
└── ...

test_data_1/             # 测试数据根目录
├── rxn1/
│   ├── RS.xyz
│   └── PS.xyz          # 测试集不包含TS.xyz
└── ...
```

### XYZ文件格式

标准XYZ格式：
```
15                          # 第1行：原子数量
                            # 第2行：注释行（可为空）
C   0.000  0.000  0.000    # 第3行起：元素符号 + X/Y/Z坐标（单位：Å）
H   1.089  0.000  0.000
...
```

**重要**: 同一反应的RS.xyz、PS.xyz、TS.xyz必须：
- ✅ 原子数量相同
- ✅ 原子顺序相同
- ✅ 使用相同的元素符号

### 数据验证脚本

创建 `check_data.py` 验证数据格式：

```python
from ase.io import read
import os

def check_reaction_data(rxn_dir):
    """检查单个反应数据"""
    rs_file = os.path.join(rxn_dir, 'RS.xyz')
    ps_file = os.path.join(rxn_dir, 'PS.xyz')
    ts_file = os.path.join(rxn_dir, 'TS.xyz')
    
    # 读取文件
    atoms_r = read(rs_file)
    atoms_p = read(ps_file)
    
    # 检查原子数
    assert len(atoms_r) == len(atoms_p), "RS和PS原子数不一致"
    
    # 检查元素
    assert atoms_r.get_chemical_symbols() == atoms_p.get_chemical_symbols(), \
        "RS和PS元素不匹配"
    
    # 检查TS（如果存在）
    if os.path.exists(ts_file):
        atoms_t = read(ts_file)
        assert len(atoms_t) == len(atoms_r), "TS原子数不一致"
    
    print(f"✓ {os.path.basename(rxn_dir)}: {len(atoms_r)}个原子")
    return True

# 检查所有数据
data_dir = "train_data"
for rxn_name in os.listdir(data_dir):
    rxn_path = os.path.join(data_dir, rxn_name)
    if os.path.isdir(rxn_path):
        check_reaction_data(rxn_path)
```

---

## 🚀 模型训练

### 快速开始（使用默认参数）

```bash
python train_xyz.py \
    --train_dir ./train_data \
    --output_dir ./outputs_xyz \
    --batch_size 16 \
    --epochs 50 \
    --lr 1e-4
```

训练将自动：
- ✅ 划分训练集/验证集（90%/10%）
- ✅ 保存最佳模型到 `outputs_xyz/best_model.pt`
- ✅ 记录TensorBoard日志到 `outputs_xyz/logs/`
- ✅ 每5轮保存checkpoint

### 完整训练参数说明

```bash
python train_xyz.py \
    --train_dir ./train_data           # 训练数据目录
    --output_dir ./outputs_xyz         # 输出目录
    --batch_size 16                    # 批次大小（CPU建议8-16，GPU可32-64）
    --epochs 50                        # 训练轮数
    --lr 1e-4                          # 学习率
    --hidden_dim 256                   # Transformer隐藏层维度
    --num_layers 6                     # Transformer层数
    --num_heads 8                      # 注意力头数
    --dropout 0.1                      # Dropout比例
    --num_workers 4                    # 数据加载线程数
    --val_split 0.1                    # 验证集比例
    --save_interval 5                  # checkpoint保存间隔
```

### 训练输出说明

**控制台输出**:
```
Epoch 1/50
训练: 100%|████████████| 567/567 [05:23<00:00]
  Train Loss: 0.0758 | Train RMSD: 0.411 Å
  Val Loss: 0.0715 | Val RMSD: 0.399 Å | Success: 73.61%
✓ 保存最佳模型 (RMSD: 0.399 Å)
```

**输出文件**:
```
outputs_xyz/
├── best_model.pt              # 最佳模型（根据验证RMSD）
├── checkpoint_epoch_5.pt      # 定期checkpoint
├── checkpoint_epoch_10.pt
├── ...
└── logs/                      # TensorBoard日志
    └── events.out.tfevents...
```

### 从checkpoint恢复训练

如果训练中断，可以从checkpoint恢复：

```bash
python train_xyz.py \
    --train_dir ./train_data \
    --output_dir ./outputs_xyz \
    --resume ./outputs_xyz/checkpoint_epoch_10.pt
```

### 训练监控（TensorBoard）

在另一个终端启动TensorBoard：

```bash
tensorboard --logdir outputs_xyz/logs --port 6006
```

访问 http://localhost:6006 查看：
- **Loss/train**, **Loss/val**: 训练和验证损失曲线
- **RMSD/train**, **RMSD/val**: RMSD指标曲线
- **SuccessRate/val**: 成功率（RMSD<0.5Å的比例）
- **LR**: 学习率变化

---

## 🔮 模型预测

### 对测试集进行预测

```bash
python predict_xyz.py \
    --test_dir ./test_data_1 \
    --model_path ./outputs_xyz/best_model.pt \
    --output_dir ./test_data_1
```

### 参数说明

```bash
python predict_xyz.py \
    --test_dir ./test_data_1           # 测试数据目录
    --model_path ./outputs_xyz/best_model.pt  # 模型路径
    --output_dir ./test_data_1         # 输出目录（默认：直接在测试目录生成）
    --reactant_file RS.xyz             # 反应物文件名
    --product_file PS.xyz              # 产物文件名
    --output_file TS_pred.xyz          # 输出文件名
```

### 预测输出

预测完成后，每个反应文件夹会生成 `TS_pred.xyz`:

```
test_data_1/
├── rxn1/
│   ├── RS.xyz
│   ├── PS.xyz
│   └── TS_pred.xyz        # ✅ 预测的过渡态
├── rxn2/
│   ├── RS.xyz
│   ├── PS.xyz
│   └── TS_pred.xyz
└── ...
```

### 预测速度

**性能参考** (Intel i7-12700H, 12核):
- 单个反应: ~15ms
- 500个反应: ~8秒
- 速度: ~60-70 reactions/s

**GPU加速** (如果可用):
- 速度可提升3-5倍
- 自动检测GPU兼容性

---

## 📊 结果评估

### 使用提供的评估脚本

```bash
python get_rmsd.py <预测目录> <真实目录>
```

示例（如果有真实TS标签）:
```bash
python get_rmsd.py ./test_data_1 ./test_data_1_truth
```

### 评估指标

**RMSD (Root Mean Square Deviation)**:
- 使用Kabsch算法对齐后计算
- 公式: RMSD = sqrt(mean(||pred_pos - true_pos||²))
- **成功标准**: RMSD < 0.5 Å

**Success Rate**:
- 定义: RMSD < 0.5 Å 的反应比例
- 本模型: **82.74%** (验证集)

### 自定义评估脚本

```python
from ase.io import read
from ts_prediction.utils.metrics import calculate_rmsd

# 读取预测和真实结构
pred = read('test_data_1/rxn1/TS_pred.xyz')
true = read('test_data_1_truth/rxn1/TS.xyz')

# 计算RMSD
rmsd = calculate_rmsd(
    pred.get_positions(),
    true.get_positions()
)

print(f"RMSD: {rmsd:.4f} Å")
print(f"成功: {'✓' if rmsd < 0.5 else '✗'}")
```

---

## 🔧 技术细节

### 模型架构

```
输入层
├─ 原子嵌入 (Atomic Number → 128维)
└─ 距离特征提取 (RS距离矩阵 + PS距离矩阵 → 256维)
   ↓
特征融合 (128 + 256 → 256维)
   ↓
Transformer Encoder
├─ 6层 Transformer Layer
├─ 8个注意力头
├─ 前馈网络维度: 256 × 4 = 1024
└─ Dropout: 0.1
   ↓
过渡态预测层
├─ 插值系数预测: MLP → α (0-1)
└─ 偏移预测: MLP → Δ (N×3)
   ↓
输出: TS = α·RS + (1-α)·PS + Δ
```

**模型参数**: 13,020,932 (13M)

### 核心算法

**1. 距离矩阵计算**:
```python
def calc_dist_matrix(pos):
    # pos: (B, N, 3) - 批次, 原子数, 坐标
    diff = pos.unsqueeze(2) - pos.unsqueeze(1)  # (B, N, N, 3)
    dist = torch.norm(diff, dim=-1)  # (B, N, N)
    return dist
```

**2. 过渡态预测**:
```python
# 插值系数 (0-1)
alpha = sigmoid(mlp_alpha(features))  # (N, 1)

# 坐标偏移
delta = mlp_delta(features)  # (N, 3)

# 最终预测
ts_pos = alpha * r_pos + (1-alpha) * p_pos + delta
```

**3. RMSD计算（Kabsch对齐）**:
```python
from scipy.optimize import linear_sum_assignment

# 1. 中心化
p1_centered = p1 - p1.mean(axis=0)
p2_centered = p2 - p2.mean(axis=0)

# 2. SVD对齐
H = p1_centered.T @ p2_centered
U, S, Vt = np.linalg.svd(H)
R = Vt.T @ U.T

# 3. 应用旋转并计算RMSD
p1_aligned = p1_centered @ R
rmsd = np.sqrt(np.mean(np.sum((p1_aligned - p2_centered)**2, axis=1)))
```

### 训练策略

**优化器**: AdamW
- Learning Rate: 1e-4
- Weight Decay: 1e-5
- Betas: (0.9, 0.999)

**学习率调度**: Cosine Annealing
- T_max: 总epoch数
- η_min: 0

**损失函数**: MSE Loss
```python
loss = F.mse_loss(predicted_coords, true_coords)
```

**数据划分**:
- 训练集: 90% (9,065个反应)
- 验证集: 10% (1,008个反应)
- 随机种子: 42 (保证可复现)

### 性能优化

**CPU优化**:
```python
# 自动使用所有CPU核心
torch.set_num_threads(os.cpu_count())
```

**数据加载优化**:
```python
DataLoader(
    dataset,
    batch_size=16,
    num_workers=4,      # 多进程加载
    pin_memory=True,    # 固定内存（GPU加速）
    collate_fn=custom_collate  # 自定义批次处理
)
```

**模型编译优化** (PyTorch 2.0+):
```python
model = torch.compile(model)  # JIT编译加速
```

---

## 📈 实验结果

### 训练收敛曲线

| Epoch | Train Loss | Val Loss | Val RMSD | Success Rate |
|-------|-----------|----------|----------|--------------|
| 1     | 0.0758    | 0.0715   | 0.399 Å  | 73.61%       |
| 10    | 0.0559    | 0.0583   | 0.352 Å  | 80.26%       |
| 20    | 0.0409    | 0.0559   | 0.338 Å  | 83.04%       |
| 30    | 0.0282    | 0.0575   | 0.337 Å  | 83.04%       |
| 42    | 0.0211    | 0.0565   | 0.333 Å  | 82.74% ⭐    |
| 50    | 0.0201    | 0.0569   | 0.334 Å  | 82.84%       |

**最佳模型** (Epoch 42):
- 验证RMSD: **0.333 Å**
- 成功率: **82.74%**
- 训练时长: ~4小时 (CPU, 12核)

### 性能对比

| 方法 | RMSD | Success Rate | 参数量 |
|------|------|--------------|--------|
| 线性插值 (baseline) | 0.600 Å | 45% | 0 |
| 本模型 (Transformer) | **0.333 Å** | **82.74%** | 13M |
| 改善 | ↓ 44.5% | ↑ 37.7% | - |

---

## ❓ 常见问题

### Q1: GPU不兼容怎么办？

**A**: 程序会自动检测GPU兼容性，不兼容时自动切换到CPU。CPU性能已优化，可正常训练。

对于新GPU (如RTX 40/50系列)，可尝试：
```bash
pip install --pre torch --index-url https://download.pytorch.org/whl/nightly/cu121
```

### Q2: 内存不足？

**A**: 减小batch_size:
```bash
python train_xyz.py --batch_size 8  # 默认16
```

### Q3: 训练速度慢？

**A**: 优化建议：
1. 增加 `--num_workers` (数据加载并行)
2. 使用GPU (如果可用)
3. 减小模型规模: `--hidden_dim 128 --num_layers 4`

### Q4: 如何提高预测精度？

**A**: 可尝试：
1. 增加训练轮数: `--epochs 100`
2. 数据增强（旋转、平移）
3. 增大模型: `--hidden_dim 512 --num_layers 8`
4. 模型集成（训练多个模型取平均）

### Q5: 支持其他数据格式吗？

**A**: 支持HDF5格式，使用 `hdf5_dataset.py`。也可扩展支持LMDB等格式。

---

## 📞 技术支持

如遇问题，请检查：
1. ✅ Python版本 ≥ 3.8
2. ✅ 所有依赖正确安装
3. ✅ 数据格式符合要求
4. ✅ 文件路径正确
5. ✅ 磁盘空间充足

---

## 📄 文件清单

提交包应包含以下文件：

```
✅ requirements.txt           # Python依赖包
✅ train_xyz.py               # 训练脚本（含详细注释）
✅ predict_xyz.py             # 预测脚本（含详细注释）
✅ get_rmsd.py                # RMSD评估脚本
✅ ts_prediction/             # 核心代码包
   ├── models/
   │   ├── __init__.py
   │   └── ts_predictor.py   # 模型定义（含架构注释）
   ├── data/
   │   ├── __init__.py
   │   └── xyz_dataset.py    # 数据加载器
   └── utils/
       ├── xyz_io.py         # XYZ文件读写
       └── metrics.py        # RMSD计算
✅ outputs_xyz/best_model.pt  # 训练好的模型
✅ training_history.log       # 训练日志
✅ 复现指南.md                 # 本文档
✅ README.md                  # 项目说明
```

---

**祝训练成功！** 🚀

